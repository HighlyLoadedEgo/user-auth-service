# Backend Lynx

## Разделы документации

- [Запуск приложения](#запуск-приложения)
- [Руководство Git-commit](#руководство-git-commit)
- [Архитектура приложения](#архитектура-приложения)

## Запуск приложения
> Переименовать .env.local.example -> .env
### Запуск приложения в docker-compose
```bash
docker compose up
```
### Запуск проекта локально
> Предварительно создать и активировать venv
>> Поднять все необходимые сервисы в docker и настроить .env
```bash
pip install poetry
poetry install
pre-commit install
```
```bash
python -O main.py
```
## Руководство Git-commit
### Формат коммита
```
{type}({scope}): {subject}
```
### Правила для коммитов

#### Разрешенные типы - {types}
- `feat` -> новая функциональность
- `fix` -> исправление ошибок
- `docs` -> документация
- `style` -> форматирование, вещи связанные с линтингом
- `refactor` -> реструктуризация кода без изменения внешнего поведения
- `test` -> добавление отсутствующих тестов
- `chore` -> техническое обслуживание
- `init` -> инициальный коммит
- `rearrange` -> файлы перемещены, добавлены, удалены и т.д.
- `update` -> обновление кода (версии, совместимость библиотек)
#### Область - {scope}
Где было сделано изменение (например, файл, компонент, пакет).
> Это может быть что угодно, указывающее место изменения коммита, например, контроллер, клиент, логгер и т.д.
### Тело сообщения - {body}
Здесь даются подробности о коммите, включая:

- мотивация для изменения (сломанный код, новая функция и т.д.)
- сравнение с предыдущим поведением

Некоторые правила для тела сообщения:

Должно быть в настоящем времени.
- Должно быть повелительным наклонением.
- Строки должны быть менее 80 символов в длину.

### Пример

```
fix(users): fix bug in user repository.
```

## Архитектура приложения
Наше приложение построено с использованием модульной структуры, обеспечивающей четкое разделение обязанностей и удобство в расширении функционала. Взаимодействие между модулями установлено по принципу иерархии и зависимостей:
- `application`: Центральный модуль, который отвечает за инициализацию API, настройку конечных точек и интеграцию настроек сервера uvicorn. Этот модуль имеет доступ ко всем остальным модулям и служит точкой входа в приложение.
- `core`: Модуль 'core' служит основой для всего приложения, содержа в себе общие настройки, подключения к базам данных и брокерам сообщений, конфигурацию логирования, а также общие ошибки и константы. Модули `modules` и `application` могут обращаться к core для доступа к общим ресурсам и утилитам.
- `modules`: Здесь реализована бизнес-логика, связанная с отдельными сущностями приложения. Модуль 'modules' включает UseCases, DTOs, специфические ошибки сущностей и другие компоненты бизнес-логики. Этот модуль может взаимодействовать с `core` и `config` для получения необходимых настроек и ресурсов.
- `config`: Модуль 'config' отвечает за извлечение и управление настройками конфигурации из переменных окружения. Это делает его доступным для всех других модулей, которые могут требовать этих настроек для своей работы. Модуль `config` не обращается к другим модулям, выполняя роль поставщика конфигурационных данных.
>Таким образом, модули application и modules могут активно использовать ресурсы core и config, в то время как core и config предоставляют необходимые ресурсы без прямого обращения к другим модулям. Эта структура предоставляет гибкую систему управления зависимостями и облегчает масштабирование приложения.

## Авторизация
>  Общая логика авторизации

### POST /auth/refresh
Этот эндпоинт используется для обновления токена доступа пользователя.
#### Параметры запроса:
- `credentials` (HTTPAuthorizationCredentials): Токен обновления, предоставляемый через заголовок авторизации.
#### Зависимости:
- `jwt_manager` (JWTManager): Менеджер JWT, используемый для обновления токенов доступа.
#### Ответы:
- `200 OK`: Успешное обновление, возвращает новый токен доступа.
- `401 Unauthorized`: Ошибка авторизации, возвращается при истечении срока действия токена или если токен недействителен.
### POST /auth/sign-out
Этот эндпоинт используется для очистки кеша связанного с пользователем в системе.
#### Параметры запроса:
- `current_user` (BaseUserDTO): Данные текущего пользователя, полученные через систему авторизации.
#### Зависимости:
- `redis_client` (RedisClient): Клиент Redis для управления кэшем.
#### Ответы:
- `204 No Content`: Успешный выход из системы, кэш пользователя очищен.
- `401 Unauthorized`: Ошибка авторизации, возвращается при неудачной попытке выйти из системы.
>  Авторизация отвчиающая за админ панель
### POST /admin/auth/sign-up

Этот эндпоинт используется для регистрации нового администратора и отпарвки письма на почту для ее подтверждения.
#### Параметры запроса:
- `registrate_data` (UserCreateRequestSchema): Схема данных для создания пользователя, включает в себя информацию, такую как имя пользователя, электронная почта и пароль.
#### Зависимости:
- `celery_app` (Celery): Экземпляр Celery для асинхронной обработки задач.
- `session` (AsyncSession): Сессия для асинхронного взаимодействия с базой данных.
- `redis_client` (RedisClient): Клиент Redis для кэширования данных.
#### Ответы:
- `204 No Content`: Успешная регистрация без возвращения каких-либо данных.
- `400 Bad Request`: Ошибка в запросе, возвращается при неверно сформированных данных.
- `409 Conflict`: Ошибка, указывающая на то, что электронная почта уже используется.
### POST /admin/auth/sign-in
Этот эндпоинт используется для аутентификации администратора и получения токенов доступа.
#### Параметры запроса:
- `login_data` (UserLoginRequestSchema): Схема данных для входа пользователя, содержит электронную почту и пароль.
#### Зависимости:
- `session` (AsyncSession): Сессия для асинхронного взаимодействия с базой данных.
- `jwt_manager` (JWTManager): Менеджер для создания и управления JWT токенами.
- `redis_client` (RedisClient): Клиент Redis для кэширования данных.
#### Ответы:
- `200 OK`: Успешная аутентификация, возвращает токен доступа.
- `401 Unauthorized`: Ошибка аутентификации, возвращается при неверных учетных данных.
- `403 Forbidden`: Доступ запрещен, возвращается при попытке входа без соответствующих прав.
### POST /admin/auth/confirm
Этот эндпоинт используется для подтверждения электронной почты.
#### Параметры запроса:
- `token` (str): Токен для подтверждения электронной почты, передается в качестве параметра запроса.
#### Зависимости:
- `session` (AsyncSession): Сессия для асинхронного взаимодействия с базой данных.
- `celery_app` (Celery): Экземпляр Celery для асинхронной обработки задач.
- `redis_client` (RedisClient): Клиент Redis для кэширования данных.
#### Ответы:
- `204 No Content`: Успешное подтверждение электронной почты без возвращения данных.
- `404 Not Found`: Ошибка, возвращается когда токен не найден или неверен.
- `403 Forbidden`: Доступ запрещен, возвращается при попытке подтверждения без соответствующих прав.
- `409 Conflict`: Конфликт, возникает если электронная почта уже используется или подтверждена.

>  Авторизация отвчиающая за вею часть

### POST /web/auth/sign-up
Этот эндпоинт используется для регистрации администратора в системе.
#### Параметры запроса:
- `registrate_data` (UserCreateRequestSchema): Схема данных для регистрации пользователя, содержит информацию, такую как электронная почта, имя, фамилия, пароль и т.д.
#### Зависимости:
- `session` (AsyncSession): Сессия для асинхронного взаимодействия с базой данных.
- `celery_app` (Celery): Экземпляр Celery для асинхронной обработки задач.
- `redis_client` (RedisClient): Клиент Redis для кэширования данных.
#### Ответы:
- `204 No Content`: Успешная регистрация, не возвращает данных.
- `400 Bad Request`: Ошибка, возникает при неверных данных для регистрации.
- `409 Conflict`: Конфликт, возникает если электронная почта уже используется.
### POST /web/auth/sign-in
Этот эндпоинт используется для аутентификации администратора и получения токенов доступа.
#### Параметры запроса:
- `login_data` (UserLoginRequestSchema): Схема данных для входа пользователя, содержит электронную почту и пароль.
#### Зависимости:
- `session` (AsyncSession): Сессия для асинхронного взаимодействия с базой данных.
- `jwt_manager` (JWTManager): Менеджер для создания и управления JWT токенами.
- `redis_client` (RedisClient): Клиент Redis для кэширования данных.
#### Ответы:
- `200 OK`: Успешная аутентификация, возвращает токен доступа.
- `401 Unauthorized`: Ошибка аутентификации, возвращается при неверных учетных данных.
- `403 Forbidden`: Доступ запрещен, возвращается при попытке входа без соответствующих прав.
### POST /web/auth/confirm
Этот эндпоинт используется для подтверждения электронной почты.
#### Параметры запроса:
- `token` (str): Токен для подтверждения электронной почты, передается в качестве параметра запроса.
#### Зависимости:
- `session` (AsyncSession): Сессия для асинхронного взаимодействия с базой данных.
- `celery_app` (Celery): Экземпляр Celery для асинхронной обработки задач.
- `redis_client` (RedisClient): Клиент Redis для кэширования данных.
#### Ответы:
- `204 No Content`: Успешное подтверждение электронной почты без возвращения данных.
- `404 Not Found`: Ошибка, возвращается когда токен не найден или неверен.
- `403 Forbidden`: Доступ запрещен, возвращается при попытке подтверждения без соответствующих прав.
- `409 Conflict`: Конфликт, возникает если электронная почта уже подтверждена.
